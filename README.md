# pdfGenerate 前端动态生成pdf（包含二维码、分页、水印、盖章等）
### 公司要做一个前端生成pdf不动产调查的需求，主要需求和方案
1. 根据查询人查询其在某省有几套房产，并把不动产情况和抵押情况（如有）回显出来，用表格显示，数据不同表格数据项和结构也不同。
2. 输出的pdf要留足页边距，并做好分页，右下角做好分页标识，形如当前页码/总页码，“1 / 3”
3. 每一页要在指定的位置，盖章，最后一页比较特殊盖在落款机构“某省自然资源产权中心”上
4. 每页设置水印，在pdf上，每行3个，每页4行
5. 做一个表单，通过表单输入一样可以输出产调
6. 根据输入的不动产编号，生成二维码，并且所有数据在提交后修改实时更改
   
### 主要难点
- [ ]  Q1、因为是canvas所以分页时候涉及到裁剪，容易出来半个字的问题
A1: 很遗憾，这个方案并不能根本解决生成的pdf被裁剪的问题

- [x]  Q2、canvas转pdf容易出现不清晰的问题，过于清晰又有pdf文件过大的问题
A2: 谨慎设置scale，这个参数不能写太大，设置`scale：2`是合适的，否则会导致文件过大。

- [x]  Q3、vue生成的canvas是像素，pdf是的单位是mm，应该对其进行缩放，缩放的比例是多少？
A3:就是说canvas的width是等于a4的可用宽度的，297-marginLeft-marginRight，但高度需要*a4height/a4width（即a4纸可用部分的宽高比进行缩放）

- [x]  Q4、如何确定落款的位置，使最后一页的章落在落款上
A4: 落款的位置是可以计算的，思路就是【canvas的页面高度-（上+下边距）*总页码+下边距】%a4纸的可用高度。

- [x]  Q5、水印应该出现在文字下方，容易出现被盖住导致没有水印和水印盖住文字的问题
A5: 只能做到不盖在章上，但不能解决不盖在文字上方的问题。

### 当时没有做过类似，根据网上资料定下来使用pdf.js和canvas2pdf.js，
> 1. 根据查询人查询其在某省有几套房产，并把不动产情况和抵押情况（如有）回显出来，用表格显示，数据不同表格数据项和结构也不同。

通过vue生成符合需求的table并绘制在canvas中，不难
> 2. 输出的pdf要留足页边距，并做好分页，右下角做好分页标识，形如当前页码/总页码，“1 / 3”

a4纸的宽高是210mm*297mm，减去上下的边距，计算可用的height，使用canvas的高度除以（每一页a4纸可用的）height计算出总页码，同理裁剪canvas完成分页
```
    html2canvas(content, {
      logging: false,
      allowTaint: true,
      taintTest: false,
      useCORS: true,
      dpi: 300,
      scale: 2
    }).then((canvas) => {
      var pdf = new jsPDF('p', 'mm', 'a4');
      var ctx = canvas.getContext('2d'),
        a4w = 188, a4h = 275,
        imgHeight = Math.floor(a4h * canvas.width / a4w),
```
> 3. 每一页要在指定的位置，盖章，最后一页比较特殊盖在落款机构“某省自然资源产权中心”上

指定的位置上盖章就是pdf增加一张图片，最后一页一开始想设置绝对定位来解决，但显示效果和addImage相差太多，最后通过计算落款的位置解决
```
 // 在非最后一页添加章的图片
        if (this.currentPage <= totalPages) {
          pdf.addImage(sealImage, 'PNG', 141, 230, 50, 50);
          pdf.addPage();
        }//最后一页章要在落款上
        else{
          pdf.addImage(sealImage, 'PNG',
          139, 
          Math.floor(Math.min(a4h, a4w * page.height / page.width) - 23 * totalPages + 12) % a4h, 50, 50);
        }
```
> 4. 每页设置水印，在pdf上，每行3个，每页4行

水印问题addImage进行解决，但显示有些问题，如已出现下面
   > Q5、水印应该出现在文字下方，容易出现被盖住导致没有水印和水印盖住文字的问题 的问题。
> 5. 做一个表单，通过表单输入一样可以输出产调

基本的vue操作，表单验证、传值问题，很简单

> 6. 根据输入的不动产编号，生成二维码，并且所有数据在提交后修改实时更改

引入qrcode.js前端生成二维码，并不难，详见`generateQRCode()`方法

### 写在最后，由于保密条款，不便展示全部代码，只展示关键逻辑代码。
